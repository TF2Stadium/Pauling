machine:
  services:
    - postgresql
    - docker
  environment:
    DATABASE_NAME: "circle_test"
    DATABASE_USERNAME: "ubuntu"
    DATABASE_PASSWORD: ""
    GO15VENDOREXPERIMENT: 1
    GOPATH: "/home/ubuntu/.go_workspace"
dependencies:
  pre:
      - go version
      - mkdir -p $GOPATH/src
      - mkdir -p $GOPATH/pkg
      - mkdir -p $GOPATH/bin
      - git submodule init
      - git submodule update
      #Vendoring
      #- wget https://github.com/Masterminds/glide/releases/download/0.8.3/glide-0.8.3-linux-amd64.tar.gz
      #- tar -xvf glide-*.tar.gz
      #- ./linux-amd64/glide -y ./glide.yaml install
test:
  override:
      - go test $(go list ./... | grep -v /vendor/)
deployment:
  master:
    branch: master
    commands:
      - mkdir binaries
      - go build -o binaries/pauling-prod *.go
      - rsync -rl -e "ssh -p $SSH_PORT" binaries/* $BACKEND_USER@tf2stadium.com:$BACKEND_DEPLOY_PATH_PROD
      - ssh -p $SSH_PORT $BACKEND_USER@tf2stadium.com $BACKEND_DEPLOY_SCRIPT_PROD
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
      - cd docker && make -B
      - docker push tf2stadium/pauling
  dev:
    branch: dev
    commands:
      - mkdir binaries
      - go build -race -o binaries/pauling-dev *.go
      - rsync -rl -e "ssh -p $SSH_PORT" binaries/* $BACKEND_USER@tf2stadium.com:$BACKEND_DEPLOY_PATH_DEV
      - ssh -p $SSH_PORT $BACKEND_USER@tf2stadium.com $BACKEND_DEPLOY_SCRIPT_DEV
